<!--

Короче нах.
Сервис сохраняет историю радио кпи и
предоставляет ее в вроде удобном виде 
с возможностью прослушивания
by SvineruS (svinua)

Раз уж ты уже открыл исходный код:
Я не позиционирую себя как фронтэндер,
даже просил помощи в чате, но никто не 
отозвался!! Пидары бля. Жрите теперь.

Делал без либ, да. Жс бывает без либ.
В одном файле потому что так удобнее
со стороны бэкэнда, песни в base64
потому что плеер иначе не перематывает.

По всем вопросам мне в телегу
http:t.me/svinerus


-->

<style>
html {
	position: relative;
	min-height: 100%;
	font-size: 100%;
}
body {
	background: #eee;
	font-family: helvetica, serif;
	margin: 0; padding: 0;
	margin-bottom: 60px;
	color: #555;
	min-width: 430px;
}

.header {
	position: fixed;
	top: 0;
	width: 100%;
	padding: 15px 20px;
	background: #565fa2;
	color: white;
	z-index: 1;
}

.sitename {
	font-size: 2em;
	text-decoration: none;
	color: white;
}
.sitename a:link, .sitename a:visited, .sitename a:active { text-decoration: none; color: white;}


.casttitle {
	overflow: hidden;
	text-overflow: ellipsis;
    white-space: nowrap;
}

.player {
	background: rgba(20, 20, 20, 0.3);
    position: absolute;
    top: 10px;
    bottom: 10px;
    right: 60px;
    left: 16em;
	padding: 0.9em 1%;
	border-radius: 5px;
	cursor: pointer;
}
.player-pause {
	position: absolute;
	margin-top: -2px;
	margin-left: 5px;
	cursor: pointer;
}
.player-title {
	display: inline-block;
	position: absolute;
	right: 100px;
    left: 50px;
	margin-left: 5%;

}
.player-time, .player-volume_wrap {
	float: right;
}

.player-progress {
	position: absolute;
	top: 0; left: 0;
	background: #343858;
	height: 100%;
	width: 0%;
	z-index: -1;
	border-radius: 5px;
	transition-duration: 0.5s;
}

.player-volume {
	appearance: none;
	-webkit-appearance: none;
	transform: rotate(270deg);
	outline: none;
	width: 3.5em;
	height: 100%;
	margin: 0px;
	background: #343858;
	cursor: pointer;
}
.player-volume::-webkit-slider-thumb {
	-webkit-appearance: none;
    width: 10px;
    height: 100%;
	background-color: #565fa2;
	border: solid black 0.5px;
}

.main {
	margin: 0 auto;
	margin-top: 5em;
	padding: 0 2%;
	text-align: center;
}


.input {
	display: inline-block;
	margin-top: 5px;
	height: 50px;
	font-size: 2em;
	border: none;
    width: 100%;
    padding: 0 10%;
}

#DOM_next_day_btn {
	width: 100%;
	padding: 10px;
	margin-top: 5px;
	font-weight: bold;
	height: 50px;
}



.songs {
	margin-top: 20px;
}

.item {
	position: relative;
	display: block;
	padding: 10px 15px;
	margin-bottom: -1px;
	background-color: #ffffff;
	border: 1px solid #ecf0f1;
	cursor: default;
	height: 1.5em
}

.item-playing {
	background-color: #cacbf8;
}

.splitter {
	margin-top: 18px;
    background: #565fa2;
    color: white;
	border-radius: 5px 5px 0 0;
}
.splitter-day {
    font-weight: bold;
    margin-top: 25px;
	border-radius: 5px;
}



.time {
	float: left;
	margin-top: -3px;
	padding: 3px 7px;
	font-family: DaysRegular, Arial, "Helvetica CY", "Nimbus Sans L", sans-serif;
	font-weight: bold;
	text-align: center;
	background-color: #e5e3ff;
	border-radius: 5px;
}


.item-casttitle {
	position: absolute;
	left: 135px;
	right: 80px;
	margin-left: 5%;
	cursor: pointer;
}

.artist {
	font-weight: bold;
	margin-right: 1%;
}

.title {
	margin-left: 1%;
}


.play-btn {
	float: right;
	padding: 3px 7px;
	font-size: 13px;
	font-weight: bold;
	color: #ffffff;
	background-color: #2c3e50;
	border-radius: 10px;
	line-height: 1;
	cursor: pointer;
}
.play:before {
	content: '▶';
}
.pause:before {
	content: '❚❚';
}

.copy {
	position: absolute;
    z-index: -20;
}

.foot {
  position: absolute;
  bottom: 0;
  width: 100%;
  line-height: 40px;
}
.foot a:link, .foot a:visited, .foot a:active { text-decoration: none; color: black;}

.hidden {visibility: hidden;}
button:hover {background-color: #c6c8de;}


.rotate {	animation: spin 1s linear 0s infinite; display: inline-block;} @keyframes spin { 	from { transform:rotate(0deg); } 	to { transform:rotate(360deg); } }

.para_num-1 {background: #4fc3f7;}
.para_num-2 {background: #29b6f6;}
.para_num-3 {background: #03a9f4;}
.para_num-4 {background: #039be5;}
.para_num-5 {background: #6a76cc;}

</style>
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<body>
<audio id="player" ontimeupdate="Progress()" 
	   onpause="playerOnPause()" onplay="playerOnPlay()"></audio>
<div class="header">
	<span class="sitename"><a href="http://t.me/kpiradio_bot">KPIRADIOBOT</a></span>
	<div id="DOMplayer" class="player hidden" onclick="playerProgress(event, this)">
		<div class="player-progress" id="playerprogressbar"></div>
		<span class="player-pause play" id="playerpause" onclick="playerPlayPause()"></span>
		<span class="player-title casttitle" id="playertitle">Lol - kek</span>
		<span class="player-volume_wrap">
            <input type="range" class="player-volume" oninput="playerVolume(this.value)" onclick="event.stopPropagation()">
        </span>
		<span class="player-time" id="playertime">14:88</span>
	</div>
</div>
<div class="main">
	<input class="input"id="DOM_date" required onchange="search()" type="date" min="2018-08-21">
	<div class="songs" >
		<div id="DOM_songs"></div>
		<button class="item hidden" onclick="search(true)" id="DOM_next_day_btn">Дальше</button>
	</div>
</div>


<div class="foot"><marquee direction="right">
<span class="rotate">卐</span>
©<a href='https://t.me/svinerus'>svinerus</a>, 2018, для КПИ
<span class="rotate">卐</span>
</marquee></div>



</body>



<script>
	DOM_date = document.getElementById('DOM_date')
	DOM_songs = document.getElementById('DOM_songs')
	DOM_next_day_btn = document.getElementById('DOM_next_day_btn')

	DOM_player = document.getElementById('DOMplayer')
	DOM_player_progressbar = document.getElementById('playerprogressbar')
	DOM_player_btn = document.getElementById('playerpause')
	DOM_player_time = document.getElementById('playertime')
	DOM_player_title = document.getElementById('playertitle')
	
	MIN_DATE = new Date('2018-08-21')
	
	var Curr_item_playing
	var Curr_day
	old_para_num = 0
	
    date_format = {	  weekday: 'long',      month: 'long',      day: 'numeric',    }

	
	init()
	function init() {
		today = date_yyyymmdd(new Date())
		DOM_date.value = today
		DOM_date.max = today
		DOM_date.min = date_yyyymmdd(MIN_DATE)
				
		player.volume = 0.5
		search()
	}

	function search(nextday=false) {
		if (!nextday) {
			date = DOM_date.value
			if (date == "") {
				alert('Введите дату')
				return
			}
			date = new Date(date)
			tableRemove()
			
		}
		else 
			date = new Date(+date - 1000*60*60*24)
		
		Curr_day = date
		
		if (+date - 1000*60*60*24 < +MIN_DATE)
			DOM_next_day_btn.classList.add('hidden')
		else 
			DOM_next_day_btn.classList.remove('hidden')
				
		res = ajax('getday', +date/1000)
		res = JSON.parse(res)

		tableInsert(res)
		
		if (res.length == 0)
			search(true)
	}



	function tableInsert(res) {
		full_html = getSongItemSplitter(true, +Curr_day)
		for (var i=0; i<res.length; i++) {
			track = res[i]
			html = getSongItem(track)
			full_html += html
		}
		DOM_songs.innerHTML += full_html


	}

	function getSongItem(item) {
        html = ''

        if (item.para_num != old_para_num) {
			old_para_num = item.para_num
            html += getSongItemSplitter(false, item.para_num)
		}
		
		title = (item.artist + (item.artist?' - ':'')+ item.title)
		title = title.replace(/'/g, "&#39;")

	    html += "<div class='item track'>" +
		"<span class='time'>"+date_hhmm(item.time_start)+" - "+date_hhmm(item.time_stop)+"</span>" +
		"<span class='item-casttitle casttitle' onclick='copyTrack(this)'>" +
			"<input type='text' class='copy' value='" + title + "'>" +
			"<span class='artist'>"+item.artist+"</span>" +
			"<span class='title'>"+item.title+"</span>" +
		"</span>" +
		"<span class='play-btn play' onclick='play(\""+ item.path +'", "'+ title +"\", this)'></span>" +
		"</div>"

		return html
    }

    function getSongItemSplitter(isDay, data) {
		if (isDay) {
		    html = new Date(data).toLocaleString("ru", date_format)
		    return "<div class='item splitter splitter-day'>"+html+"</div>"
		}
		if (Curr_day.getDay() == 0) // вс
			if (data == 1)
				html = 'Дневной эфир'
			else {
				html = 'Вечерний эфир'
				data = 5
			}
		else {
			if (data == 5) html = 'Вечерний эфир'
			else html = 'После ' + data + ' пары'
		} 
		
		return "<div class='item splitter para_num-"+ data +"'>"+html+"</div>"
    }

	
	function play(path, title, element) {
		DOMplayer.classList.remove('hidden')
		if (!element.classList.contains('pause')) { //play
			if (Curr_item_playing != element.parentElement) {
				if (Curr_item_playing) {
					playerOnPause()
					Curr_item_playing.classList.remove('item-playing')
				}
				Curr_item_playing = element.parentElement
				Curr_item_playing.classList.add('item-playing')
				player.src = ajax('play/' + path)
				DOM_player_title.innerHTML = title			
				Progress()
			}
			playerPlayPause(true)
		} else {								  //pause
			playerPlayPause(false)
		}		
	}
	
	function playerVolume(volume) {
		player.volume = volume / 100
	}

	function playerProgress(event, bar) {
		if (!player.duration) return;
		progress = (event.clientX - bar.offsetLeft) / bar.clientWidth
		player.currentTime = player.duration * progress
		Progress() 
	}

	function playerPlayPause(state=undefined) {
		if (state === undefined) {
			if (player.paused) player.play()
			else player.pause()
			event.stopPropagation()
		} else {
			if (state) player.play()
			else player.pause()
		}
	}

	function Progress() {
		DOM_player_progressbar.style.width = player.currentTime/player.duration*100 + '%'
		DOM_player_time.innerHTML = second2mmss(player.currentTime)
	}

	function playerOnPause() {
		DOM_player_btn.classList.remove('pause')
		if (Curr_item_playing)
			Curr_item_playing.getElementsByClassName('play-btn')[0].classList.remove('pause')
	}
	
	function playerOnPlay() {
		DOM_player_btn.classList.add('pause')
		if (Curr_item_playing)
			Curr_item_playing.getElementsByClassName('play-btn')[0].classList.add('pause')
	}
	
	function copyTrack(element) {
		element.firstElementChild.select()
		document.execCommand('copy')
		//TODO notif
	}

	function tableRemove() {
		DOM_songs.innerHTML = '';
	}

	function date_yyyymmdd(date) {
		return date.toISOString().substring(0, 10)
	}
	function date_hhmm(date) {
		s = new Date(date*1000).toLocaleTimeString().substring(0, 5)
		if (s[4] == ':') s = '0' + s.substring(0, 4)
		return s
	}
	function second2mmss(sec) {
		d = new Date(null)
		d.setSeconds(sec)
		return d.toISOString().substr(14, 5);
	}
	
	function ajax(url, data) {
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.open("POST", 'history/' + url, false);
		xmlhttp.send(data);
		if(xmlhttp.status == 200) return xmlhttp.responseText;
		
	}
</script>


